---
title:"Significance Testing of Differences Between Predictions: Slopes, Contrasts and Pairwise Comparisons"
author: "Daniel LÃ¼decke"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Significance Testing of Differences Between Predictions: Slopes, Contrasts and Pairwise Comparisons}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r set-options, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "png",
  fig.width = 7,
  fig.height = 3.5,
  message = FALSE, warning = FALSE)
options(width = 800)

if (!requireNamespace("ggplot2", quietly = TRUE) ||
    !requireNamespace("parameters", quietly = TRUE)) {
  knitr::opts_chunk$set(eval = FALSE)
}
```

# Hypothesis testing for categorical predictors

## Within `episode`, do levels differ?

```{r}
library(ggeffects)
library(parameters)
library(ggplot2)

set.seed(123)
n <- 200
d <- data.frame(
  outcome = rnorm(n),
  group = as.factor(sample(c("treatment", "control"), n, TRUE)),
  episode = as.factor(sample(1:3, n, TRUE)),
  sex = as.factor(sample(c("female", "male"), n, TRUE, prob = c(.4, .6)))
)
model1 <- lm(outcome ~ group + episode, data = d)
model_parameters(model1)
```

## Predictions

```{r}
mydf <- ggpredict(model1, "episode")
mydf

plot(mydf)
```

## Pairwise comparisons

We could now ask whether the predicted outcome for `episode = 1` is significantly different from the predicted outcome at `episode = 2`.

```{r echo=FALSE}
p <- plot(mydf)
line_data <- as.data.frame(mydf)[1:2, ]

p + geom_line(
  data = line_data,
  mapping = aes(x = as.numeric(x), y = predicted),
  color = "red"
)
ht1 <- hypothesis_test(model1, "episode")
```

To do this, we use the `hypothesis_test()` function. This function, like `ggpredict()`, accepts the model object as first argument, followed by the _focal predictors_ of interest, i.e. the variables of the model for which contrasts or pairwise comparisons should be calculated.

By default, when all focal terms are categorical, a pairwise comparison is performed.

```{r}
hypothesis_test(model1, "episode")
```

For our quantity of interest, the contrast between episode `r ht1$episode[1]`, we see the value `r ht1$Contrast[1]`, which is exactly the difference between the predicted outcome for `episode = 1` (`r round(mydf$predicted[1], 2)`) and `episode = 2` (`r round(mydf$predicted[2], 2)`). The related p-value is `r round(ht1$p.value[1], 2)`, indicating that the difference between the predicted values of our outcome at these two levels of the factor _episode_ is indeed statistically significant.

## Does same level of episode differ between groups?

The next example includes a pairwise comparison of an interaction between two categorical predictors.

```{r}
model2 <- lm(outcome ~ group * episode, data = d)
model_parameters(model2)
```

## Predictions

```{r}
mydf <- ggpredict(model2, c("episode", "group"))
mydf

plot(mydf)
```

## Pairwise comparisons

We could now ask whether the predicted outcome for `episode = 2` is significantly different depending on the level of `group`? In other words, do the groups `treatment` and `control` differ when `episode = 2`?

```{r echo=FALSE}
p <- plot(mydf)
line_data <- as.data.frame(mydf)[3:4, 1:2]
line_data$group_col <- "control"
# p + geom_line(
#   data = line_data,
#   aes(x = as.numeric(x), y = predicted, group = NULL, color = NULL),
#   color = "orange",
#   arrow = arrow(length = unit(0.1, "inches"), ends = "both", angle = 40)
# )
p + geom_segment(
  data = line_data,
  aes(
    x = as.numeric(x) - .06, xend = as.numeric(x) + .06,
    y = predicted[1], yend = predicted[2], group = NULL, color = NULL
  ),
  color = "orange",
  arrow = arrow(length = unit(0.1, "inches"), ends = "both", angle = 40)
)
ht2 <- hypothesis_test(model2, c("episode", "group"))
```

```{r}
# we want "episode = 2-2" and "group = control-treatment"
hypothesis_test(model2, c("episode", "group"))
```

For our quantity of interest, the contrast between groups `treatment` and `control` when `episode = 2` is `r round(ht2$Contrast[8], 2)`.

```{r}
# predictions - our groups we want to include in our comparison
# are row 2 ("b2") and row 5 ("b5")
hypothesis_test(model2, c("episode", "group"), test = NULL)

# compute specific contrast directly
hypothesis_test(model2, c("episode", "group"), test = "b2 = b5")
```
